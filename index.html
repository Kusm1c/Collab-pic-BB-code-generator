<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur d'ImageMap BBCode</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        #image-container {
            position: relative;
            border: 1px solid #ccc;
            display: inline-block;
            margin-top: 20px;
        }
        #image-container img {
            max-width: 100%;
            height: auto;
            display: block;
            user-drag: none; /* Disable image dragging in Webkit browsers */
            -webkit-user-drag: none; /* Disable image dragging in non-Webkit browsers */
        }
        .selection {
            position: absolute;
            border: 2px dashed red;
            pointer-events: none;
        }
        #bbcode-output {
            width: 80%;
            margin-top: 20px;
            font-family: monospace;
        }
    </style>
</head>
<body>

<h1>Générateur d'ImageMap BBCode</h1>

<input type="file" id="image-upload" accept="image/*">
<div id="image-container">
    <img id="image" alt="Image à annoter" style="display: none;">
</div>

<div>
    <label>URL du lien : <input type="text" id="link-url"></label>
    <label>Nom : <input type="text" id="link-name"></label>
    <button onclick="addSelection()">Ajouter la sélection</button>
</div>

<pre id="bbcode-output"></pre>

<script>
    const image = document.getElementById('image');
    const imageUpload = document.getElementById('image-upload');
    const container = document.getElementById('image-container');
    const bbcodeOutput = document.getElementById('bbcode-output');
    let startX, startY, endX, endY;
    let isSelecting = false;
    const selections = [];

    imageUpload.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                image.src = e.target.result;
                image.style.display = 'block';
                resetSelections();
            };
            reader.readAsDataURL(file);
        }
    });

    image.addEventListener('click', (e) => {
        const rect = image.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;

        if (!isSelecting) {
            // Start a new selection
            startX = x;
            startY = y;
            isSelecting = true;
            
            // Remove any existing selection
            resetSelections();

            // Create a new selection element
            const selectionDiv = document.createElement('div');
            selectionDiv.className = 'selection';
            selectionDiv.style.left = `${startX}%`;
            selectionDiv.style.top = `${startY}%`;
            container.appendChild(selectionDiv);

        } else {
            // Finish the selection
            endX = x;
            endY = y;
            isSelecting = false;

            // Calculate the dimensions and position
            const width = Math.abs(endX - startX);
            const height = Math.abs(endY - startY);
            const posX = Math.min(startX, endX);
            const posY = Math.min(startY, endY);

            const selectionDiv = container.querySelector('.selection');
            selectionDiv.style.left = `${posX}%`;
            selectionDiv.style.top = `${posY}%`;
            selectionDiv.style.width = `${width}%`;
            selectionDiv.style.height = `${height}%`;
        }
    });

    function addSelection() {
        const url = document.getElementById('link-url').value;
        const name = document.getElementById('link-name').value;
        if (!url || !name || startX == null || startY == null || endX == null || endY == null) return;

        const width = Math.abs(endX - startX);
        const height = Math.abs(endY - startY);
        const posX = Math.min(startX, endX);
        const posY = Math.min(startY, endY);

        // Store the BBCode selection data
        selections.length = 0; // Ensure only one selection at a time
        selections.push(`${posX.toFixed(2)} ${posY.toFixed(2)} ${width.toFixed(2)} ${height.toFixed(2)} ${url} ${name}`);
        updateBBCode();
    }

    function updateBBCode() {
        let bbcode = `[imagemap]\n${image.src}\n`;
        selections.forEach(selection => {
            bbcode += `${selection}\n`;
        });
        bbcode += `[/imagemap]`;
        bbcodeOutput.textContent = bbcode;
    }

    function resetSelections() {
        selections.length = 0;
        bbcodeOutput.textContent = '';
        const existingSelections = container.querySelectorAll('.selection');
        existingSelections.forEach(selection => selection.remove());
    }
</script>

</body>
</html>
